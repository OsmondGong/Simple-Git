#!/bin/dash

if (test $# -gt 3 || test $# -lt 2) 
then
    echo "usage: girt-commit [-a] -m commit-message"
    exit 1
fi

count=$(ls .girt/repository/ | wc -l)

if (test $1 = '-a')
then
    for files in .girt/index/*
    do
        fileAdd=$(echo $files | sed "s/.girt\/index\///")
        ../girt-add $fileAdd
    done
fi

change=0

if (test $(diff -q ".girt/index/" ".girt/repository/$((count-1))/" | wc -l) -gt 0) > /dev/null 2>&1
then
    change=1
fi

for files in .girt/index/*
do
    fileName=$(echo $files | sed "s/.girt\/index\//.girt\/repository\/$((count - 1))\//")
    if (! cmp -s $files $fileName && test -f $files) > /dev/null 2>&1
    then
        change=1
    fi
    if (test $change -eq 1)
    then
        break
    fi
done

if (test $1 = "-m")
then
    if (test $# -ne 2)
    then
        echo "usage: girt-commit [-a] -m commit-message"
        exit 1
    fi
    message="$count $2"
elif (test $1 = "-a")
then
    if (test $2 != "-m" || test $# -ne 3)
    then
        echo "usage: girt-commit [-a] -m commit-message"
        exit 1
    fi
    message="$count $3"
fi

if (test $change -eq 0)
then
    echo "nothing to commit"
    exit
fi

echo $message >>.girt/message.txt

mkdir .girt/repository/$count

for files in .girt/index/*
do
    fileName=$(echo $files | sed "s/.girt\/index\//.girt\/repository\/$count\//")
    cp "$files" "$fileName" > /dev/null 2>&1
done

cp .girt/message.txt .girt/commitPath/$count

echo "Committed as commit $count"